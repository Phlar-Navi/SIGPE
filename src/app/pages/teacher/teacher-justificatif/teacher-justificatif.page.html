<ion-content>
  <div class="min-h-screen bg-gray-50 text-gray-800">
    <!-- Sidebar Menu -->
    <app-sidebar></app-sidebar>

    <!-- Contenu principal -->
    <div class="p-6 transition-all duration-300 ease-in-out" [ngClass]="{ 'md:ml-64': !isSmallScreen }">
      <!-- Header -->
      <app-header>
      </app-header>

      <!-- Tableau des justificatifs -->
      <div class="mt-6 bg-white p-6 rounded-2xl shadow-sm border border-gray-100 transition-all hover:shadow-md">
        
        <h2 class="text-2xl font-bold mb-6 text-blue-600 flex items-center gap-2">
          <ion-icon name="time-outline"></ion-icon>
          Justificatifs recus
        </h2>

        <div class="mt-4 w-full overflow-hidden rounded-lg shadow-xs bg-white">
          <div class="w-full overflow-x-auto">
            <table class="w-full whitespace-no-wrap">
              <thead>
                <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b bg-gray-50">
                  <th class="px-4 py-3">Exp√©diteur</th>
                  <th class="px-4 py-3">Session</th>
                  <th class="px-4 py-3">Statut</th>
                  <th class="px-4 py-3">Date</th>
                  <th class="px-4 py-3">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y">
                <tr *ngFor="let justificatif of justificatifs" class="text-gray-700 hover:bg-gray-50 transition-colors">
                  <td class="px-4 py-3">
                    <div class="flex items-center text-sm">
                      <div class="relative w-8 h-8 mr-3 rounded-full">
                        <img class="object-cover w-full h-full rounded-full border border-gray-200" 
                            [src]="justificatif.etudiant.photo" 
                            [alt]="justificatif.expeditor">
                        <div class="absolute inset-0 rounded-full shadow-inner" aria-hidden="true"></div>
                      </div>
                      <div>
                        <p class="font-semibold"> {{ justificatif.etudiant.nom }}</p>
                        <p class="text-xs text-gray-500">{{ justificatif.etudiant.prenom }}</p>
                      </div>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    {{ justificatif.matiere.nom }}
                  </td>
                  <td class="px-4 py-3 text-xs">
                    <span class="px-2 py-1 font-semibold leading-tight rounded-full"
                          [ngClass]="{
                            'text-green-700 bg-green-200': justificatif.statut === 'Accept√©',
                            'text-yellow-700 bg-yellow-100': justificatif.statut === 'En cours',
                            'text-orange-400 bg-orange-100': justificatif.statut === 'Renvoy√©',
                            'text-red-700 bg-red-100': justificatif.statut === 'Refus√©',
                            'text-blue-700 bg-blue-100': justificatif.statut === 'Nouveau',
                          }">
                      {{ justificatif.statut }}
                    </span>
                  </td>
                  <td class="px-4 py-3 text-sm">
                    {{ justificatif.presence.session.heure_debut | date:'dd/MM/yyyy' }}
                  </td>
                  <!-- Actions conditionnelles -->
                  <td class="px-4 py-3 text-sm">
                    <div class="flex space-x-2 items-center">
                      <!-- R√©pondre -->
                      <button *ngIf="justificatif.statut === 'En cours'"
                              (click)="selectJustificatif(justificatif)"
                              class="text-yellow-500 hover:text-yellow-700"
                              title="R√©pondre"> <!-- (click)="redigerJustificatif(justificatif)" -->
                        <ion-icon name="create-outline"></ion-icon>
                      </button>

                      <!-- Modifier -->
                      <button *ngIf="justificatif.statut === 'Renvoy√©'"
                              (click)="modifyJustificatif(justificatif)"
                              class="text-blue-500 hover:text-blue-700"
                              title="Editer"> <!-- (click)="modifierJustificatif(justificatif)" -->
                        <ion-icon name="eye-outline"></ion-icon>
                      </button>

                      <!-- Supprimer -->
                      <button *ngIf="['Accept√©', 'Refus√©'].includes(justificatif.statut)"
                              (click)="deleteJustification(justificatif)"
                              class="text-red-600 hover:text-red-800"
                              title="Supprimer"> <!-- (click)="supprimerJustificatif(justificatif)" -->
                        <ion-icon name="trash-outline"></ion-icon>
                      </button>

                      <!-- Voir -->
                      <!-- <button *ngIf="['Accept√©', 'Renvoy√©', 'Refus√©', 'En cours'].includes(justificatif.statut)"
                              
                              class="text-blue-500 hover:text-blue-700"
                              title="Voir">
                        <ion-icon name="eye-outline"></ion-icon>
                      </button> -->

                      <!-- T√©l√©charger -->
                      <!-- <button *ngIf="justificatif.document"
                              
                              class="text-green-500 hover:text-green-700"
                              title="T√©l√©charger">
                        <ion-icon name="download-outline"></ion-icon>
                      </button> -->
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>


        </div>

      </div>

      <!-- Modal pour r√©pondre -->
      <div *ngIf="showReponseModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white w-full max-w-2xl rounded-lg shadow-lg overflow-hidden">
          <div class="flex justify-between items-center px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">R√©ponse au justificatif</h3>
            <button class="text-gray-500 hover:text-gray-700" (click)="showReponseModal = false">Fermer</button>
          </div>

          <div class="p-6 space-y-6">
            <div class="bg-gray-100 p-4 rounded-md">
              <div class="text-lg font-medium">{{ selectedJustificatif?.etudiant.nom }} {{ selectedJustificatif?.etudiant.prenom }}</div>
              <div class="text-sm text-gray-600">{{ selectedJustificatif?.matiere.nom }} du {{ selectedJustificatif?.presence.session.heure_debut }}</div>
              <p class="mt-4">{{ selectedJustificatif?.message }}</p>

              <a *ngIf="selectedJustificatif?.piece_jointes" class="mt-4 inline-flex items-center text-blue-600 hover:underline" [href]="getPieceJointeUrl(selectedJustificatif.piece_jointes)" target="_blank" download>
                üìé Voir la pi√®ce jointe
              </a>
            </div>

            <div>
              <label class="block font-medium mb-2">D√©cision</label>
              <div class="space-y-2">
                <label class="flex items-center gap-2">
                  <input type="radio" [(ngModel)]="reponse.decision" value="Accept√©" class="accent-blue-600" />
                  Accepter
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" [(ngModel)]="reponse.decision" value="Renvoy√©" class="accent-blue-600" />
                  Renvoyer
                </label>
                <label class="flex items-center gap-2">
                  <input type="radio" [(ngModel)]="reponse.decision" value="Refus√©" class="accent-blue-600" />
                  Refuser
                </label>
              </div>
            </div>

            <div>
              <label class="block font-medium mb-2">Commentaire</label>
              <textarea rows="3" [(ngModel)]="reponse.commentaire" class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-blue-300 resize-none"></textarea>
            </div>

            <button (click)="submitReponse()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
              Envoyer la r√©ponse
            </button>
          </div>
        </div>
      </div>


      <!-- modal pour modifier -->
      <div *ngIf="showJustificatifModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white w-full max-w-3xl rounded-lg shadow-lg overflow-hidden">
          <div class="flex justify-between items-center px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">D√©tail du justificatif</h3>
            <button class="text-gray-500 hover:text-gray-700" (click)="cancelEdit()">Fermer</button>
          </div>

          <div class="p-6 space-y-6">
            <div class="bg-gray-100 p-4 rounded-md">
              <div class="text-lg font-medium">Exp√©diteur : {{ selectedJustificatif?.etudiant.nom }} {{ selectedJustificatif?.etudiant.prenom }}</div>
              <div class="text-sm text-gray-600 mt-1">
                Mati√®re : {{ selectedJustificatif?.matiere.nom }}<br />
                Date : {{ selectedJustificatif?.presence.session.heure_debut | date:'short' }}
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Message de justification</label>
              <textarea [(ngModel)]="selectedJustificatif.message"
                        [readonly]="!isEditing || utilisateur !== 'ETU'"
                        class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-blue-300 resize-none"
                        rows="3"></textarea>
            </div>

            <div *ngIf="selectedJustificatif.piece_jointes">
              <label class="block text-sm font-medium text-gray-600 mb-2">Pi√®ce jointe</label>
              <a [href]="getPieceJointeUrl(selectedJustificatif.piece_jointes)" target="_blank" download
                class="inline-flex items-center text-blue-600 hover:underline">
                üìé T√©l√©charger
              </a>
            </div>

            <div *ngIf="isEditing && utilisateur === 'ETU'">
              <label class="block text-sm font-medium text-gray-600 mb-2">Nouvelle pi√®ce jointe</label>
              <input type="file" (change)="handleFileInput($event)" />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Votre r√©ponse</label>
              <textarea [(ngModel)]="selectedJustificatif.reponse_enseignant"
                        [readonly]="!isEditing || utilisateur !== 'ENS'"
                        class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-blue-300 resize-none"
                        rows="3"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Statut</label>
              <select [(ngModel)]="selectedJustificatif.statut"
                      [disabled]="!isEditing || utilisateur !== 'ENS'"
                      class="w-full p-3 border border-gray-300 rounded focus:ring focus:ring-blue-300">
                <option value="Accept√©">Accept√©</option>
                <option value="Refus√©">Refus√©</option>
                <option value="Renvoy√©">Renvoy√©</option>
              </select>
            </div>

            <div *ngIf="!isEditing" class="text-right">
              <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" (click)="startEdit()">Modifier</button>
            </div>

            <div *ngIf="isEditing" class="flex justify-end space-x-4">
              <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" (click)="submitModification()">Enregistrer</button>
              <button class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" (click)="cancelEdit()">Annuler</button>
            </div>
          </div>
        </div>
      </div>



    </div>

  </div>
</ion-content>